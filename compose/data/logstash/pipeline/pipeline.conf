filter {
  grok {
    match => {
      "message" => [
        "^(?<ts>%{TIMESTAMP_ISO8601})\s+(?<rest>.*)$",
        "^(?<ts>%{YEAR}-%{MONTHNUM}-%{MONTHDAY}[ T]%{TIME})\s+(?<rest>.*)$"
      ]
    }
    tag_on_failure => []
  }

  if [rest] {
    mutate {
      replace => { "message" => "%{rest}" }
      remove_field => ["rest"]
    }
    date {
      match  => ["ts","ISO8601","yyyy-MM-dd HH:mm:ss,SSS","yyyy-MM-dd HH:mm:ss"]
      target => "@timestamp"
      remove_field => ["ts"]
    }
  }

  kv {
    source => "message"
    field_split_pattern => "\s+"
    value_split => "="
    include_brackets => false
    trim_key => " \""
    trim_value => " \""
  }

  mutate {
    rename => { "level" => "log.level" }
    add_field => { "event.dataset" => "mariadb.sim" }
    add_field => { "service.name"  => "mariadb-log-sim" }
  }
}

input {
  file {
    path => "/logs/mariadb-sim.log"
    start_position => "beginning"
    sincedb_path   => "/usr/share/logstash/data/sincedb-mariadb"
    mode           => "read"
    exit_after_read => false
    stat_interval  => 5
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "mariadb-sim-logs-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}
